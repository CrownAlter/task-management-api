# Render Blueprint for Task Management API
# Infrastructure as Code for Render
# Documentation: https://render.com/docs/blueprint-spec
#
# ⚠️ FREE TIER CONFIGURATION ⚠️
# This configuration uses Render's FREE tier with the following limitations:
# 
# Web Service (Free):
#   - 750 hours/month shared across all free services
#   - Spins down after 15 minutes of inactivity
#   - Cold starts take 30-60 seconds
#   - 512 MB RAM, 0.1 CPU
#   - No persistent disk (files stored in /tmp are ephemeral)
#
# PostgreSQL (Free):
#   - Valid for 90 DAYS only, then requires upgrade
#   - 256 MB RAM
#   - 1 GB storage
#   - Max 97 connections
#   - No automated backups
#
# For production use, upgrade to paid plans (Starter $7/month, Standard $25/month)

services:
  # Spring Boot Application Service
  - type: web
    name: task-management-api
    env: docker
    runtime: docker
    
    # Docker Configuration
    dockerfilePath: ./Dockerfile
    dockerContext: .
    
    region: oregon
    plan: free  # Free tier (750 hours/month, spins down after inactivity)
    branch: main

    # Health Check Configuration
    healthCheckPath: /actuator/health
    
    # Scaling Configuration (requires paid plan)
    # numInstances: 1  # Start with 1, scale as needed
    
    # Auto-deploy on git push
    autoDeploy: true

    # Environment Variables
    envVars:
      # JVM Configuration (optimized for container)
      - key: JAVA_TOOL_OPTIONS
        value: -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication -Djava.security.egd=file:/dev/./urandom

      # Spring Profile
      - key: SPRING_PROFILES_ACTIVE
        value: prod

      # Database Configuration (Render-managed PostgreSQL)
      - key: DATABASE_URL
        fromDatabase:
          name: task-management-db
          property: connectionString

      - key: DB_HOST
        fromDatabase:
          name: task-management-db
          property: host

      - key: DB_PORT
        fromDatabase:
          name: task-management-db
          property: port

      - key: DB_NAME
        fromDatabase:
          name: task-management-db
          property: database

      - key: DB_USER
        fromDatabase:
          name: task-management-db
          property: user

      - key: DB_PASSWORD
        fromDatabase:
          name: task-management-db
          property: password

      # JWT Security Configuration
      # IMPORTANT: Set JWT_SECRET in Render Dashboard as a Secret File or Environment Variable
      # Generate a secure secret: openssl rand -base64 64
      - key: JWT_SECRET
        sync: false  # Must be set manually in Render Dashboard for security

      - key: JWT_EXPIRATION
        value: 86400000  # 24 hours

      - key: JWT_REFRESH_EXPIRATION
        value: 604800000  # 7 days

      # File Upload Configuration
      # NOTE: Free tier does NOT support persistent disk
      # Files stored in container are EPHEMERAL and will be lost on restart
      # For production file storage, upgrade to paid plan or use external service (AWS S3, Cloudinary)
      - key: FILE_UPLOAD_DIR
        value: /tmp/uploads  # Temporary storage only (free tier limitation)

      - key: FILE_MAX_SIZE
        value: 10485760  # 10MB

      # CORS Configuration
      # IMPORTANT: Update with your actual frontend domain(s)
      - key: CORS_ALLOWED_ORIGINS
        value: https://your-frontend-domain.com,https://www.your-frontend-domain.com

      # Database Connection Pool (optimized for Render Free Tier)
      # Render Free PostgreSQL: Max 97 connections (expires after 90 days)
      # Render Starter PostgreSQL: Max 97 connections
      # Render Standard PostgreSQL: Max 300 connections
      - key: SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE
        value: 3  # Very conservative for free tier

      - key: SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE
        value: 1

      - key: SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT
        value: 30000  # 30 seconds

      - key: SPRING_DATASOURCE_HIKARI_IDLE_TIMEOUT
        value: 600000  # 10 minutes

      - key: SPRING_DATASOURCE_HIKARI_MAX_LIFETIME
        value: 1800000  # 30 minutes

      # PostgreSQL Connection Parameters (for Render)
      - key: SPRING_DATASOURCE_HIKARI_DATA_SOURCE_PROPERTIES_SOCKET_TIMEOUT
        value: 30

      - key: SPRING_DATASOURCE_HIKARI_DATA_SOURCE_PROPERTIES_TCP_KEEP_ALIVE
        value: true

      # Logging Configuration
      - key: LOGGING_LEVEL_ROOT
        value: INFO

      - key: LOGGING_LEVEL_COM_ADEWUNMI
        value: INFO

      - key: LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB
        value: WARN

      # Server Configuration
      - key: SERVER_COMPRESSION_ENABLED
        value: true

      - key: SERVER_TOMCAT_MAX_CONNECTIONS
        value: 5000

      - key: SERVER_TOMCAT_MAX_THREADS
        value: 50

      # Actuator Configuration
      - key: MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE
        value: health,info,metrics

      - key: MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED
        value: true

    # Persistent Disk for File Uploads
    # WARNING: Persistent disk is NOT available on FREE tier
    # Uncomment below when you upgrade to a paid plan (Starter or higher)
    # disk:
    #   name: task-uploads
    #   mountPath: /var/data/uploads
    #   sizeGB: 1  # Minimum 1GB on paid plans

# PostgreSQL Database
databases:
  - name: task-management-db
    databaseName: task_management_db  # Explicit database name
    user: task_admin  # Explicit username
    plan: free  # FREE tier: Valid for 90 days, then requires upgrade to paid plan
    region: oregon  # Use same region as web service for lower latency
    ipAllowList: []  # Empty allows all Render services (recommended)
    
    # Note: Free database expires after 90 days
    # Automatic backups are only available on paid plans
    # postgresMajorVersion: 15  # Specify PostgreSQL version
