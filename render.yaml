# Render Blueprint for Task Management API
# Infrastructure as Code for Render
# Documentation: https://render.com/docs/blueprint-spec

services:
  # Spring Boot Application Service
  - type: web
    name: task-management-api
    env: docker
    runtime: docker
    
    # Docker Configuration
    dockerfilePath: ./Dockerfile
    dockerContext: .
    
    region: oregon
    plan: starter  # Use 'starter' for free tier, 'standard' for production
    branch: main

    # Health Check Configuration
    healthCheckPath: /actuator/health
    
    # Scaling Configuration (requires paid plan)
    # numInstances: 1  # Start with 1, scale as needed
    
    # Auto-deploy on git push
    autoDeploy: true

    # Environment Variables
    envVars:
      # JVM Configuration (optimized for container)
      - key: JAVA_TOOL_OPTIONS
        value: -XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0 -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+UseStringDeduplication -Djava.security.egd=file:/dev/./urandom

      # Spring Profile
      - key: SPRING_PROFILES_ACTIVE
        value: prod

      # Database Configuration (Render-managed PostgreSQL)
      - key: DATABASE_URL
        fromDatabase:
          name: task-management-db
          property: connectionString

      - key: DB_HOST
        fromDatabase:
          name: task-management-db
          property: host

      - key: DB_PORT
        fromDatabase:
          name: task-management-db
          property: port

      - key: DB_NAME
        fromDatabase:
          name: task-management-db
          property: database

      - key: DB_USER
        fromDatabase:
          name: task-management-db
          property: user

      - key: DB_PASSWORD
        fromDatabase:
          name: task-management-db
          property: password

      # JWT Security Configuration
      # IMPORTANT: Set JWT_SECRET in Render Dashboard as a Secret File or Environment Variable
      # Generate a secure secret: openssl rand -base64 64
      - key: JWT_SECRET
        sync: false  # Must be set manually in Render Dashboard for security

      - key: JWT_EXPIRATION
        value: 86400000  # 24 hours

      - key: JWT_REFRESH_EXPIRATION
        value: 604800000  # 7 days

      # File Upload Configuration
      - key: FILE_UPLOAD_DIR
        value: /var/data/uploads  # Use Render's persistent disk mount path

      - key: FILE_MAX_SIZE
        value: 10485760  # 10MB

      # CORS Configuration
      # IMPORTANT: Update with your actual frontend domain(s)
      - key: CORS_ALLOWED_ORIGINS
        value: https://your-frontend-domain.com,https://www.your-frontend-domain.com

      # Database Connection Pool (optimized for Render)
      # Render Starter PostgreSQL: Max 97 connections
      # Render Standard PostgreSQL: Max 300 connections
      - key: SPRING_DATASOURCE_HIKARI_MAXIMUM_POOL_SIZE
        value: 5  # Conservative for starter plan (adjust based on plan)

      - key: SPRING_DATASOURCE_HIKARI_MINIMUM_IDLE
        value: 2

      - key: SPRING_DATASOURCE_HIKARI_CONNECTION_TIMEOUT
        value: 30000  # 30 seconds

      - key: SPRING_DATASOURCE_HIKARI_IDLE_TIMEOUT
        value: 600000  # 10 minutes

      - key: SPRING_DATASOURCE_HIKARI_MAX_LIFETIME
        value: 1800000  # 30 minutes

      # PostgreSQL Connection Parameters (for Render)
      - key: SPRING_DATASOURCE_HIKARI_DATA_SOURCE_PROPERTIES_SOCKET_TIMEOUT
        value: 30

      - key: SPRING_DATASOURCE_HIKARI_DATA_SOURCE_PROPERTIES_TCP_KEEP_ALIVE
        value: true

      # Logging Configuration
      - key: LOGGING_LEVEL_ROOT
        value: INFO

      - key: LOGGING_LEVEL_COM_ADEWUNMI
        value: INFO

      - key: LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB
        value: WARN

      # Server Configuration
      - key: SERVER_COMPRESSION_ENABLED
        value: true

      - key: SERVER_TOMCAT_MAX_CONNECTIONS
        value: 5000

      - key: SERVER_TOMCAT_MAX_THREADS
        value: 50

      # Actuator Configuration
      - key: MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE
        value: health,info,metrics

      - key: MANAGEMENT_ENDPOINT_HEALTH_PROBES_ENABLED
        value: true

    # Persistent Disk for File Uploads
    disk:
      name: task-uploads
      mountPath: /var/data/uploads
      sizeGB: 10  # Adjust size based on needs (10GB minimum on Render)

# PostgreSQL Database
databases:
  - name: task-management-db
    databaseName: task_management_db  # Explicit database name
    user: task_admin  # Explicit username
    plan: starter  # Use 'starter' for free tier, 'standard' or higher for production
    region: oregon  # Use same region as web service for lower latency
    ipAllowList: []  # Empty allows all Render services (recommended)
    
    # Automatic backups (available on paid plans)
    # postgresMajorVersion: 15  # Specify PostgreSQL version
